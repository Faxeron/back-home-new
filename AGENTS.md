# Agent.md — Регламент работы и архитектуры ERP

--------------------------------------------------
1. ОБЗОР СИСТЕМЫ
--------------------------------------------------
- Архитектура: Laravel 12 (backend) + Vue 3 (frontend, Vuexy/Vuetify + PrimeVue), модульная структура.
- Основные модули: finance, products (catalog), estimates (сметы), production (contracts/installations), settings, knowledge base, ACL/roles, public API.
- Основная БД: доменные данные работают через connection `legacy_new` (default connection не используется для домена). Базовая схема зафиксирована в `database/schema/legacy_new-schema.sql`, изменения — в `database/migrations_new`.
- Pricing сейчас: операционные цены живут в `product_company_prices` (public API читает только их и требует активную строку). В `products` остаются только `price_vendor`, `price_vendor_min`, `price_zakup`.
- Слепок сметы: источник истины — `estimate_items`; при создании договора формируются `contract_items` (слепок).
- Tenant/company модель: `tenant_id` + `company_id`, контекст берется из пользователя и проверяется через `user_company` + middleware.
- API: `/api/finance/*`, `/api/products/*`, `/api/estimates/*`, `/api/contracts/*`, `/api/knowledge/*`, `/api/public/*`.
- Каталог: `product_categories`, `product_subcategories`, `product_brands` имеют `slug` (уникальный по `tenant_id` + `company_id`).
- Города: `cities` имеют `slug`, а также формы `name_prepositional` и `name_genitive` для текстов.
- Текущие проблемы и техдолг фиксируются в `docs/ai/*` (здесь не дублировать).
- Архитектура docs: `docs/ai/*` (as-built обзор/API/известные проблемы), `docs/finance/*` (финансы), `docs/*.md` (модули/регламенты), `docs/templates/*` (шаблоны таблиц), `docs/schema.txt` и `docs/project-structure.txt` (фактическая схема/структура).
- Правило документации: ключевые docs обязаны иметь `REALITY STATUS` (реально/легаси/не сделано) и обновляться после изменений.

--------------------------------------------------
2. ГЛАВНАЯ ЦЕЛЬ ПРОЕКТА
--------------------------------------------------
ERP = SaaS продукт.

Система должна:
- быть мульти-tenant
- масштабируемой
- чистой архитектурно
- стабильной финансово
- с предсказуемым ценообразованием
- без хаоса в логике

--------------------------------------------------
3. ПРАВИЛА РАБОТЫ АГЕНТА
--------------------------------------------------
Каждая задача:
АНАЛИЗ > ПЛАН (для нетривиальных) > РЕАЛИЗАЦИЯ > ПРОВЕРКА > ОТЧЕТ > коммит и пуш

Никогда:
- не ломать рабочую систему
- не оставлять полурабочий код
- не делать массовый рефактор без плана

Всегда:
- исправлять ошибки
- улучшать архитектуру
- проверять систему после изменений

--------------------------------------------------
4. GIT ПРАВИЛА (ОБЯЗАТЕЛЬНО)
--------------------------------------------------
Коммиты и push выполняются сразу после выполнения задачи:

git add -A

git commit -m "осмысленное описание"

git push

--------------------------------------------------
5. БЕЗОПАСНОСТЬ
--------------------------------------------------
Никогда не коммитить:
.env
ключи
пароли
токены

Не ломать tenant-изоляцию.

--------------------------------------------------
6. ЯДРО ЦЕНООБРАЗОВАНИЯ (КЛЮЧЕВОЕ)
--------------------------------------------------
Цена зависит от company_id.

Новая архитектура:

Таблица product_company_prices:
- tenant_id
- company_id
- product_id
- price
- price_sale
- price_delivery
- montaj
- montaj_sebest

В products остаются только:
- price_vendor
- price_vendor_min
- price_zakup

Документы используют СЛЕПОК цен.
Цены в документах не плавают.

Миграция:
dual-read > dual-write > cutover

--------------------------------------------------
7. АВТОНОМНЫЙ РЕЖИМ
--------------------------------------------------
Агент работает без запросов разрешений на изменение файлов.

Останавливается только если:
- риск потери данных
- непонятная бизнес-логика влияющая на деньги
- опасная операция

Во всех остальных случаях действует самостоятельно.


--------------------------------------------------
8. ПАПКИ И ФАЙЛЫ — НА ЗАПРЕТНЫЙ СПИСОК
--------------------------------------------------
НИКОГДА не трогаем (они auto-generated и перейдут):

❌ /vendor/               — PHP зависимости (composer install)
❌ /node_modules/        — JS зависимости (pnpm install)
❌ /bootstrap/cache/*    — скомпилированный кэш Laravel
❌ /storage/logs/        — логи приложения
❌ /storage/framework/   — framework cache/sessions/testing
❌ /public/build/        — собранный фронтенд (Vite build)
❌ /dist/                — распределённый код
❌ /.git/                — git internals (работаем через git команды)
❌ .git файлы            — .gitkeep, etc
❌ .env файлы            — никогда не трогаем в коде (только через конфиг)

Правило большого пальца:
**Если папка в .gitignore или создается при npm/composer install → не трогаем!**

✅ МОЖНО и НУЖНО трогать:
- /app/                  — весь код
- /database/migrations_new/  — миграции
- /resources/ts/         — Vue компоненты
- /config/               — конфиги
- /routes/               — маршруты
- /tests/                — тесты
- composer.json, package.json (осторожно, с пониманием)


--------------------------------------------------
9. МИГРАЦИИ
--------------------------------------------------
Если для выполнения задачи ты создаешь или изменяешь таблицы, то запускай миграции самостоятельно, и проверяй результат
