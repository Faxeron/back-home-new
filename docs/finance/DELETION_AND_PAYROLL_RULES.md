# Правила удаления и ЗП

Документ фиксирует правила удаления финансовых данных и работу выплат ЗП. Это **обязательные** инварианты для ERP.

## 1) Удаление транзакций

**Доступ:** только админ/owner.

**Как удаляем:**
- API: `DELETE /api/finance/transactions/{id}`.
- Если транзакция связана с приходом/расходом:
  - удаляем связанный **receipt/spending**;
  - удаляем записи **finance_allocations**;
  - удаляем **cashbox_history**;
  - удаляем саму транзакцию.
- Если транзакция ни с чем не связана:
  - удаляем **cashbox_history** и саму транзакцию.

**Зачем:** очистка «черновиков» и неверных операций без мусора в аналитике.

## 2) Удаление договоров

**Доступ:** только админ/owner.

**Запрещено удалять, если есть деньги по договору:**
- есть **transactions**
- есть **receipts**
- есть **spendings**
- есть **finance_allocations**

В этом случае API возвращает 422 с понятным текстом.

**Если удаление разрешено, то удаляем:**
- файлы и записи **contract_documents**
- **contract_items**
- **contract_status_changes**
- записи **finance_audit_logs** по этому договору
- **payroll_accruals**
- **payroll_payout_items**
- **estimate.contract_id** → `NULL`
- сам **contract**
- если **contract_group** остался пустым — удаляем группу

**Тип удаления:** жёсткое удаление из БД.

## 3) Правила выплат ЗП

### 3.1 Начисления
- Начисление всегда привязано к **contract_id** (и, при необходимости, к документу).
- Статусы начислений: **Создано**, **Оплачено**, **Отменено**.
- У начисления есть `amount`, `paid_amount`, `paid_at`.

### 3.2 Выплата (payout)
- Выплата формируется **по одному сотруднику** и **по выбранным начислениям**.
- Создаётся **один расход** и **одна транзакция** на общую сумму.
- Для каждого начисления создаётся:
  - `payroll_payout_items`
  - `finance_allocations` (kind = `payroll`, contract_id = из начисления)
- Начисления обновляются: `paid_amount`, `paid_at`, `status`.

### 3.3 Удаление выплаты
- Удаляется расход (через FinanceService) → удаляются транзакция/allocations/история кассы.
- Откатываются `paid_amount` и `status` начислений.
- Удаляются `payroll_payout_items` и сама выплата.

## 4) Одна транзакция → несколько договоров

Это **нормально** и используется в ERP:
- один платёж может покрывать **2–3–4 договора**;
- распределение по договорам хранится в **finance_allocations**.

Правила:
- если платёж общий → `transaction.contract_id` может быть `NULL`;
- распределение сумм и аналитика договоров идут **только по allocations**;
- для ЗП и крупных закупок применяем **allocations** как единственный корректный способ разбивки.
