# Agent Rules (Pricing Core Rework)

## Р¦РµР»СЊ Рё РїСЂРёРѕСЂРёС‚РµС‚С‹
- P0: РїРµСЂРµРїРѕРґРєР»СЋС‡РёС‚СЊ РѕРїРµСЂР°С†РёРѕРЅРЅС‹Рµ С†РµРЅС‹ РЅР° РѕС‚РґРµР»СЊРЅСѓСЋ С‚Р°Р±Р»РёС†Сѓ `product_company_prices` Р±РµР· СЂРµРіСЂРµСЃСЃРёР№.
- Р”Р°РЅРЅС‹Рµ РѕСЃС‚Р°СЋС‚СЃСЏ РєРѕРЅСЃРёСЃС‚РµРЅС‚РЅС‹РјРё РґР»СЏ РґРѕРєСѓРјРµРЅС‚РѕРІ: СЃРјРµС‚С‹/РґРѕРіРѕРІРѕСЂС‹ РёСЃРїРѕР»СЊР·СѓСЋС‚ СЃР»РµРїРѕРє (snapshot).
- РђСЂС…РёС‚РµРєС‚СѓСЂР° РјСѓР»СЊС‚Рё-tenant, С‚РµРєСѓС‰Р°СЏ СЂР°Р±РѕС‚Р° вЂ” tenant_id=1.

## Workflow (РѕР±СЏР·Р°С‚РµР»СЊРЅС‹Р№)
1) Task вЂ” СЃС„РѕСЂРјСѓР»РёСЂРѕРІР°С‚СЊ РїРѕРґР·Р°РґР°С‡Сѓ Рё РіСЂР°РЅРёС†С‹ РёР·РјРµРЅРµРЅРёР№.
2) Plan вЂ” РєСЂР°С‚РєРёР№ РїР»Р°РЅ + СЃРїРёСЃРѕРє Р·Р°С‚СЂР°РіРёРІР°РµРјС‹С… С„Р°Р№Р»РѕРІ/С‚Р°Р±Р»РёС†.
3) Implement вЂ” РёР·РјРµРЅРµРЅРёСЏ С‚РѕР»СЊРєРѕ РІ РїСЂРµРґРµР»Р°С… РїР»Р°РЅР°.
4) Verify вЂ” С‚РµСЃС‚С‹/РїСЂРѕРІРµСЂРєРё + smoke-СЃС†РµРЅР°СЂРёРё.
5) Report вЂ” С‡С‚Рѕ СЃРґРµР»Р°РЅРѕ, РєР°РєРёРµ С„Р°Р№Р»С‹, РєР°РєРёРµ РєРѕРјР°РЅРґС‹, СЂРёСЃРєРё.

## Р—РѕРЅС‹ РёР·РјРµРЅРµРЅРёР№
Р Р°Р·СЂРµС€РµРЅРѕ
- `app/` (Controllers/Services/Domain/Repositories/Resources/Requests)
- `database/migrations_new/*`
- `config/*` (С‚РѕР»СЊРєРѕ РµСЃР»Рё РЅСѓР¶РЅРѕ)
- `docs/*`
- `routes/*`

Р—Р°РїСЂРµС‰РµРЅРѕ
- `vendor/`, `node_modules/`, `public/`, `storage/` (РєСЂРѕРјРµ СЏРІРЅС‹С… С„Р°Р№Р»РѕРІ, РµСЃР»Рё С‚СЂРµР±СѓРµС‚СЃСЏ),
- Р»СЋР±С‹Рµ .env/СЃРµРєСЂРµС‚С‹,
- РѕР±С…РѕРґ `FinanceService` РґР»СЏ С„РёРЅР°РЅСЃРѕРІС‹С… РѕРїРµСЂР°С†РёР№.

## Р‘РµР·РѕРїР°СЃРЅРѕСЃС‚СЊ Рё СЃС‚Р°Р±РёР»СЊРЅРѕСЃС‚СЊ
- РќРµ РєРѕРјРјРёС‚РёС‚СЊ СЃРµРєСЂРµС‚С‹/РєР»СЋС‡Рё/РєРѕРЅС„РёРіРё РѕРєСЂСѓР¶РµРЅРёСЏ.
- РќРµ РІС‹РїРѕР»РЅСЏС‚СЊ destructive-РєРѕРјР°РЅРґС‹ (reset --hard Рё С‚.Рї.).
- Р›СЋР±Р°СЏ РјРёРіСЂР°С†РёСЏ РґРѕР»Р¶РЅР° Р±С‹С‚СЊ РёРґРµРјРїРѕС‚РµРЅС‚РЅРѕР№ Рё Р±РµР·РѕРїР°СЃРЅРѕР№.
- Р’СЃРµРіРґР° РёСЃРїРѕР»СЊР·СѓРµРј connection `legacy_new` РґР»СЏ РґРѕРјРµРЅРЅС‹С… РґР°РЅРЅС‹С….
- РќРѕРІС‹Рµ С‡С‚РµРЅРёСЏ/Р·Р°РїРёСЃРё РѕРїРµСЂР°С†РёРѕРЅРЅС‹С… С†РµРЅ вЂ” С‚РѕР»СЊРєРѕ С‡РµСЂРµР· PriceResolver/PriceWriter.

## GIT DISCIPLINE (РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ)
РџРѕСЃР»Рµ **РєР°Р¶РґРѕРіРѕ С‡Р°РЅРєР°**:
1) `git status`
2) `git add -A`
3) `git commit -m "<РѕСЃРјС‹СЃР»РµРЅРЅРѕРµ СЃРѕРѕР±С‰РµРЅРёРµ>"`
4) `git push`

## Definition of Done (РґР»СЏ РєР°Р¶РґРѕРіРѕ С‡Р°РЅРєР°)
- РљРѕРґ/РјРёРіСЂР°С†РёРё РіРѕС‚РѕРІС‹ Рё СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‚ РїР»Р°РЅСѓ.
- Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ Р°РєС‚СѓР°Р»СЊРЅР° (РµСЃР»Рё РїСЂРёРјРµРЅРёРјРѕ).
- Р’С‹РїРѕР»РЅРµРЅС‹ РїСЂРѕРІРµСЂРєРё/С‚РµСЃС‚С‹.
- РћС‚С‡РµС‚ РїСЂРµРґРѕСЃС‚Р°РІР»РµРЅ.
- РљРѕРјРјРёС‚ + push РІС‹РїРѕР»РЅРµРЅС‹.

## РќРѕРІР°СЏ РјРѕРґРµР»СЊ С†РµРЅ (С†РµРЅРѕРѕР±СЂР°Р·РѕРІР°РЅРёРµ)
- **Р’ `products` РѕСЃС‚Р°СЋС‚СЃСЏ С‚РѕР»СЊРєРѕ Р·Р°РєСѓРїРѕС‡РЅС‹Рµ/РІРµРЅРґРѕСЂСЃРєРёРµ С†РµРЅС‹:**
  - `price_vendor`, `price_vendor_min`, `price_zakup`
- **РћРїРµСЂР°С†РёРѕРЅРЅС‹Рµ С†РµРЅС‹ РІ `product_company_prices`:**
  - `price`, `price_sale`, `price_delivery`, `montaj`, `montaj_sebest`
- РџСЂРёРІСЏР·РєР° С†РµРЅ: `(tenant_id, company_id, product_id)`
- РСЃС‚РѕСЂРёРё С†РµРЅ РЅРµС‚ (С‚РѕР»СЊРєРѕ С‚РµРєСѓС‰РёРµ Р·РЅР°С‡РµРЅРёСЏ).

## РўРµРєСѓС‰РёРµ РёСЃС‚РѕС‡РЅРёРєРё С†РµРЅ (legacy)
- `products`: `price`, `price_sale`, `price_delivery`, `montaj`, `montaj_sebest` + vendor/zakup.
- `PricebookService` РёРјРїРѕСЂС‚/СЌРєСЃРїРѕСЂС‚ РЅР°РїСЂСЏРјСѓСЋ РїРёС€РµС‚/С‡РёС‚Р°РµС‚ РїРѕР»СЏ `products`.
- `ProductController`/`ProductResource` РѕС‚РґР°СЋС‚ Рё РѕР±РЅРѕРІР»СЏСЋС‚ С†РµРЅС‹ РЅР°РїСЂСЏРјСѓСЋ РІ `products`.
- `EstimateTemplateService::resolvePrice()` Р±РµСЂРµС‚ `product.price_sale ?? product.price`.
- `EstimateItemController` РїСЂРё СЃРѕР·РґР°РЅРёРё РїРѕР·РёС†РёРё РёСЃРїРѕР»СЊР·СѓРµС‚ `EstimateTemplateService`.
- `ContractController::analysis()` РёСЃРїРѕР»СЊР·СѓРµС‚ `product.price_zakup` Рё `product.price_delivery` РґР»СЏ РїР»Р°РЅРѕРІРѕР№ СЃРµР±РµСЃС‚РѕРёРјРѕСЃС‚Рё.

## РЎР»РµРїРѕРє СЃРјРµС‚С‹ (snapshot)
- РСЃС‚РѕС‡РЅРёРє РёСЃС‚РёРЅС‹ РїРѕ СЃС‚СЂРѕРєР°Рј СЃРјРµС‚С‹: `estimate_items`.
- Р’ `estimate_items` С…СЂР°РЅРёС‚СЃСЏ `price` Рё `total` вЂ” СЌС‚Рѕ **СЃР»РµРїРѕРє** РЅР° РјРѕРјРµРЅС‚ СЃРѕР·РґР°РЅРёСЏ/РїРµСЂРµСЃС‡РµС‚Р°.
- `estimates.data` вЂ” legacy/РєРµС€ (РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РєР°Рє fallback РІ `ContractController::analysis()`).
- Р”РѕРєСѓРјРµРЅС‚С‹ РЅРµ РґРѕР»Р¶РЅС‹ В«РїР»С‹С‚СЊВ»: РІСЃРµ РїРµСЂРµСЃС‡РµС‚С‹ РґРѕР»Р¶РЅС‹ С„РёРєСЃРёСЂРѕРІР°С‚СЊ С†РµРЅСѓ РІ `estimate_items` Рё/РёР»Рё `contract_items`.

## РњРѕРґСѓР»Рё ERP РґР»СЏ РїРµСЂРµРїРѕРґРєР»СЋС‡РµРЅРёСЏ С†РµРЅ
1) UI С‚РѕРІР°СЂРѕРІ / РїСЂР°Р№СЃС‹ (list/view)
2) РРјРїРѕСЂС‚/СЌРєСЃРїРѕСЂС‚ РїСЂР°Р№СЃР° (xlsx)
3) РЎРјРµС‚С‹/РљРџ/РґРѕРіРѕРІРѕСЂС‹ вЂ” СЃР»РµРїРѕРє С†РµРЅ
4) Р—Р°СЂРїР»Р°С‚С‹/РјРѕС‚РёРІР°С†РёСЏ/РјР°СЂР¶РёРЅР°Р»СЊРЅРѕСЃС‚СЊ
5) РћС‚С‡РµС‚С‹

## Feature flag
- `pricing.mode = dual_read` (default)
- `pricing.mode = company_table_only` (РїРѕСЃР»Рµ cutover)

## РџСЂРѕРІРµСЂРєРё/С‚РµСЃС‚С‹
- РњРёРЅРёРјСѓРј: `phpunit` (РёР»Рё `vendor/bin/phpunit`).
- Р•СЃР»Рё С‚РµСЃС‚РѕРІ РЅРµС‚ вЂ” СЂСѓС‡РЅС‹Рµ smoke-СЃС†РµРЅР°СЂРёРё РѕР±СЏР·Р°С‚РµР»СЊРЅС‹.

## РџСЂР°РІРёР»Р° Р±РµР· СЂРµРіСЂРµСЃСЃР°
- Р¦РµРЅС‹ РІ РґРѕРєСѓРјРµРЅС‚Р°С… С‚РѕР»СЊРєРѕ РёР· snapshot (РЅРµ РёР· products/РїСЂР°Р№СЃР°).
- Р’ `products` РїРѕСЃР»Рµ cutover РЅРµ РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ С‡С‚РµРЅРёСЏ РѕРїРµСЂР°С†РёРѕРЅРЅС‹С… С†РµРЅ.
- РћР±СЏР·Р°С‚РµР»СЊРЅС‹ С‚РµСЃС‚С‹/РїСЂРѕРІРµСЂРєРё + smoke СЃС†РµРЅР°СЂРёРё РёР· Р·Р°РґР°С‡Рё.

## Smoke-СЃС†РµРЅР°СЂРёРё
- РћС‚РєСЂС‹С‚СЊ СЃРїРёСЃРѕРє С‚РѕРІР°СЂРѕРІ вЂ” С†РµРЅС‹ РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ РїРѕ company.
- Р­РєСЃРїРѕСЂС‚ РїСЂР°Р№СЃР° вЂ” РєРѕСЂСЂРµРєС‚РЅС‹Рµ С†РµРЅС‹.
- РРјРїРѕСЂС‚ РїСЂР°Р№СЃР° вЂ” РєРѕСЂСЂРµРєС‚РЅРѕ РѕР±РЅРѕРІР»СЏРµС‚ С†РµРЅС‹.
- РЎРѕР·РґР°РЅРёРµ СЃРјРµС‚С‹ вЂ” С†РµРЅР° РїРѕРґС‚СЏРіРёРІР°РµС‚СЃСЏ Рё С„РёРєСЃРёСЂСѓРµС‚СЃСЏ РІ `estimate_items`.
- РџРµСЂРµСЃС‡РµС‚/СЃРѕС…СЂР°РЅРµРЅРёРµ СЃРјРµС‚С‹ вЂ” РЅРµ Р»РѕРјР°РµС‚СЃСЏ.

## Legacy зависимости после Фазы 2 (dual-write)
- Чтение цен для UI/ресурсов: `app/Http/Resources/ProductResource.php` (price поля берутся из products).
- Каталоги/прайсы: `app/Services/Catalog/PricebookService.php` экспорт читает из products.
- Сметы: `app/Services/Estimates/EstimateTemplateService.php` берет `product.price_sale ?? product.price`.
- Договоры/анализ: `app/Http/Controllers/Api/ContractController.php` использует `product.price_delivery` (и snapshot fallback).
- Публичный API (если используется): читает цены из products.
