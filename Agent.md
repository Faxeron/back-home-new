# Agent.md — Регламент работы и архитектуры ERP

--------------------------------------------------
1. ОБЗОР СИСТЕМЫ
--------------------------------------------------
- Архитектура: Laravel 12 (backend) + Vue 3 (frontend, Vuexy/Vuetify + PrimeVue), модульная структура.
- Основные модули: finance, products (catalog), estimates (сметы), production (contracts/installations), settings, knowledge base, ACL/roles, public API.
- Основная БД: доменные данные работают через connection `legacy_new` (default connection не используется для домена).
- Pricing сейчас: операционные цены читаются из `product_company_prices` через PriceResolver; legacy-цены в `products` еще сохраняются.
- Слепок сметы: источник истины — `estimate_items`; при создании договора формируются `contract_items` (слепок).
- Tenant/company модель: `tenant_id` + `company_id`, контекст берется из пользователя и проверяется через `user_company` + middleware.
- API: `/api/finance/*`, `/api/products/*`, `/api/estimates/*`, `/api/contracts/*`, `/api/knowledge/*`, `/api/public/*`.
- Текущие проблемы: split pricing (pcp vs products), legacy `estimates.data`, public API читает legacy-цены, нет feature-flag и полного cutover.

--------------------------------------------------
2. ГЛАВНАЯ ЦЕЛЬ ПРОЕКТА
--------------------------------------------------
ERP = SaaS продукт.

Система должна:
- быть мульти-tenant
- масштабируемой
- чистой архитектурно
- стабильной финансово
- с предсказуемым ценообразованием
- без хаоса в логике

--------------------------------------------------
3. ПРАВИЛА РАБОТЫ АГЕНТА
--------------------------------------------------
Каждая задача:
АНАЛИЗ > ПЛАН > РЕАЛИЗАЦИЯ > ПРОВЕРКА > ОТЧЕТ > COMMIT > PUSH

Никогда:
- не ломать рабочую систему
- не оставлять полурабочий код
- не делать массовый рефактор без плана

Всегда:
- исправлять ошибки
- улучшать архитектуру
- проверять систему после изменений

--------------------------------------------------
4. GIT ПРАВИЛА (ОБЯЗАТЕЛЬНО)
--------------------------------------------------
После КАЖДОЙ завершённой задачи:

git add -A

git commit -m "осмысленное описание"

git push

Без push задача не считается завершённой.

--------------------------------------------------
5. БЕЗОПАСНОСТЬ
--------------------------------------------------
Никогда не коммитить:
.env
ключи
пароли
токены

Не ломать tenant-изоляцию.

--------------------------------------------------
6. ЯДРО ЦЕНООБРАЗОВАНИЯ (КЛЮЧЕВОЕ)
--------------------------------------------------
Цена зависит от company_id.

Новая архитектура:

Таблица product_company_prices:
- tenant_id
- company_id
- product_id
- price
- price_sale
- price_delivery
- montaj
- montaj_sebest

В products остаются только:
- price_vendor
- price_vendor_min
- price_zakup

Документы используют СЛЕПОК цен.
Цены в документах не плавают.

Миграция:
dual-read > dual-write > cutover

--------------------------------------------------
7. АВТОНОМНЫЙ РЕЖИМ
--------------------------------------------------
Агент работает без запросов разрешений на изменение файлов.

Останавливается только если:
- риск потери данных
- непонятная бизнес-логика влияющая на деньги
- опасная операция

Во всех остальных случаях действует самостоятельно.
